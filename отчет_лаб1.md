Настроить nginx по заданному тз:
1) Должен работать по https c сертификатом
2) Настроить принудительное перенаправление HTTP-запросов (порт 80) на HTTPS (порт 443) для обеспечения безопасного соединения.
3) Использовать alias для создания псевдонимов путей к файлам или каталогам на сервере.
4) Настроить виртуальные хосты для обслуживания нескольких доменных имен на одном сервере.



Для начала установим nginx (на macos):

```commandline
brew install nginx
```

Далее, так как нам нужно будет обслуживать несколько доменных имен,
можно сразу написать 2 скрипта на питоне, которые будут слушать разные порты:

Это будет наш project_1:
```py
from starlette.applications import Starlette
from starlette.responses import HTMLResponse
from starlette.routing import Route

async def home(request):
    return HTMLResponse(f"""<pre>
        url: {str(request.url)}
        client:
            host: {request.client.host}
            port: {request.client.port}
        headers:
            {('<br>' + '&nbsp' * 12).join(k + ': ' + v for k, v in request.headers.items())}
    </pre>""")

app = Starlette(debug=True, routes=[Route('/', home)])
```

И project_2, который особо не отличается:
```py
from starlette.applications import Starlette
from starlette.responses import HTMLResponse
from starlette.routing import Route

async def home(request):
    return HTMLResponse(f"""<pre>
        url: {str(request.url)}
        client:
            host: {request.client.host}
            port: {request.client.port}
        headers:
            {('<br>' + '&nbsp' * 12).join(k + ': ' + v for k, v in request.headers.items())}
    </pre>""")

app = Starlette(debug=True, routes=[Route('/', home),])
```

Запускать оба импровизированных "сайта" будет с помощью команды 
`uvicorn project_<num>:app`

Теперь можно приступить непосредственно к написанию nginx.conf

Открываем файл nginx.conf (который уже появился при скачивании nginx, в целом
можно создать новый и запускать nginx указывая на него, но я думаю это
не обязательно)

Удаляем все закоментированные строки

Начинаем писать, первое наше задание - настроить перенаправление 
с http на https (с 80 порта на 443):

```nginx
server {
        listen 80;
        server_name project_1.local project_2.local;
        return 301 https://$host:443$request_uri;
    }
```

Здесь мы прослушиваем 80 порт, далее 
настраиваем доменные имена - если домен, по которому 
обращаются на 80 порт project_1.local или project_2.local,
то выполняем перенаправление на 443 порт (здесь это указано явно,
но вообще не обязательно, так как https это уже 443 порт по умолчанию)

Затем пишем блоки server непосредственно для обработки запросов,
прищедших на наши python-серверы:

project_1:
```
server {
    listen 443 ssl;
    server_name project_1.local;

    ssl_certificate         /etc/nginx/ssl/nginx-selfsigned.crt;
    ssl_certificate_key     /etc/nginx/ssl/nginx-selfsigned.key;

    location / {
        proxy_pass http://127.0.0.1:8000;
    }

    location /static {
        alias /private/tmp/project1_static/;
        autoindex off;
    }
}
```
И то же самое для project_2:
```
server {
        listen 443 ssl;
        server_name project_2.local;

        ssl_certificate         /etc/nginx/ssl/nginx-selfsigned.crt;
        ssl_certificate_key     /etc/nginx/ssl/nginx-selfsigned.key;

        location / {
            proxy_pass http://127.0.0.1:8080;
        }

        location /static {
            alias /private/tmp/project2_static;
            autoindex off;
        }
    }
```
Здесь мы слушаем уже 443 порт, обязательно с помощью ssl (в этом 
и смысл https)

Указывем так же домен, который обрабатываем (server_name)

Далее указываем пути для самоподписанного сертификата, ssl_certificate - 
путь к публичному ключу сертификата, ssl_certificate_key - соответственно, 
путь к приватному ключу

В блоке location / {} мы просто выполняем проксирование запроса на 
локальный адрес, где работают наш скрипты project_1 и project_2

В блоке location /static {} мы создаем alias для 
обработки статических файлов:
вместо /static будет подставляться /private/tmp/project<num>_static

Весь файл nginx.conf будет выглядеть следующим образом:

```
worker_processes  1;

events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;


    server {
        listen 80;
        server_name project_1.local project_2.local;
        return 301 https://$host:443$request_uri;
    }

    server {
        listen 443 ssl;
        server_name project_1.local;

        ssl_certificate         /etc/nginx/ssl/nginx-selfsigned.crt;
        ssl_certificate_key     /etc/nginx/ssl/nginx-selfsigned.key;

        location / {
            proxy_pass http://127.0.0.1:8000;
        }

        location /static {
            alias /private/tmp/project1_static/;
            autoindex off;
        }
    }


    server {
        listen 443 ssl;
        server_name project_2.local;

        ssl_certificate         /etc/nginx/ssl/nginx-selfsigned.crt;
        ssl_certificate_key     /etc/nginx/ssl/nginx-selfsigned.key;

        location / {
            proxy_pass http://127.0.0.1:8080;
        }

        location /static {
            alias /private/tmp/project2_static;
            autoindex off;
        }
    }
}
```

Я столкнулся со следующими проблемами: 

изначально я создал 
папки со статическими файлами непосредственно в папке PycharmProjects/Clouds ,
но, как выяснилось, у nginx нет доступа для чтения к файлам в PycharmProjects,
поэтому было принято решение переместить их в tmp (ну можно было в другое место),
чтобы не менять права доступа для папок.

Так же, изначально у меня nginx запускался с другой конфигурацией,
поэтому нужно было явно прописывать, какую конфигурацию использовать,
с помощью команды: `sudo nginx -c /opt/homebrew/etc/nginx/nginx.conf`

Теперь, как это выглядит:

В папке tmp:

![img_1.png](img_1.png)

В браузере:

Просто страница / (для project_1) :

![img_2.png](img_2.png)
 
Пример получения файла из папки project_1_static:

![img_3.png](img_3.png)

Для Project_2 все абсолютно аналогично, нужно только поменять циферку 1 на 2